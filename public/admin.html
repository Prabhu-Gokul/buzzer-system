<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Connection Game</title>
    <link rel="stylesheet" href="style.css?v=2">
    <style>
        body {
            align-items: stretch;
        }
    </style>
</head>

<body>
    <div class="college-header">
        <div class="college-name">SUGUNA COLLEGE OF ENGINEERING</div>
        <div class="dept-name">Artificial Intelligence & Data Science | Information Technology</div>
        <div class="event-name-banner">OMNI TECH - ADMIN</div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="dot online"></div>
            <span style="font-family: 'Bungee', cursive; letter-spacing: 1px;">ADMIN CONSOLE</span>
        </div>
        <div style="font-weight: 600;">
            <span>Connected: </span><span id="participant-count">0</span>
        </div>
    </div>

    <div class="admin-grid">
        <!-- Left Column: Controls and Buzzers -->
        <div class="panel glass">
            <div class="controls" style="display: flex; gap: 1.5rem; margin-bottom: 2.5rem; justify-content: center;">
                <button class="btn btn-primary" id="start-btn" style="min-width: 250px;">START ROUND</button>
                <button class="btn btn-danger" id="reset-btn" style="min-width: 250px;">RESET ALL</button>
                <button class="btn btn-green" id="lock-btn" style="display: none; min-width: 200px;">LOCK NOW</button>
            </div>

            <div style="text-align: center; margin-bottom: 2rem;" id="qr-section">
                <h4
                    style="margin-bottom: 1rem; color: var(--text); font-family: 'Bungee', cursive; letter-spacing: 2px;">
                    SCAN TO JOIN</h4>
                <div style="display: inline-block; padding: 1rem; background: white; border-radius: 15px;">
                    <img id="qr-code" src="" alt="Scan to join" style="display: block; width: 140px; height: 140px;">
                </div>
                <p id="join-url" style="margin-top: 1rem; font-size: 0.8rem; color: var(--text); font-weight: 600;"></p>
            </div>

            <h3 style="font-family: 'Bungee', cursive; letter-spacing: 1px; color: var(--text);">Current Buzzers</h3>
            <div class="positions" id="buzz-results" style="margin-top: 1rem;">
                <!-- Buzzers will appear here -->
            </div>
        </div>

        <!-- Right Column: Participant List and Scoring -->
        <div class="panel glass">
            <h2 style="color: #a855f7; font-family: 'Bungee', cursive; font-size: 2rem; margin-bottom: 0.5rem;">
                Leaderboard</h2>
            <hr style="border: 0.5px solid rgba(255,255,255,0.2); margin-bottom: 1.5rem;">

            <ul class="participant-list" id="participant-list" style="margin-bottom: 2.5rem;">
                <!-- Participants will appear here -->
            </ul>

            <h3 style="font-family: 'Bungee', cursive; letter-spacing: 1px; color: var(--text);">Round History</h3>
            <div id="history-log"
                style="font-size: 0.8rem; color: var(--text-dim); overflow-y: auto; max-height: 250px; margin-top: 1rem;">
                <!-- History logs -->
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const lockBtn = document.getElementById('lock-btn');
        const buzzResults = document.getElementById('buzz-results');
        const participantList = document.getElementById('participant-list');
        const historyLog = document.getElementById('history-log');

        startBtn.onclick = () => socket.emit('admin_start');
        resetBtn.onclick = () => socket.emit('admin_reset');
        lockBtn.onclick = () => {
            socket.emit('admin_logRound', { winners: [] });
            socket.emit('admin_reset');
        };

        // Generate QR Code dynamically
        const currentUrl = window.location.origin;
        document.getElementById('qr-code').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(currentUrl)}`;
        document.getElementById('join-url').textContent = currentUrl;

        socket.on('participantUpdate', (participants) => {
            document.getElementById('participant-count').textContent = participants.length;
            participantList.innerHTML = participants
                .sort((a, b) => b.score - a.score)
                .map(p => `
                    <li class="participant-item" style="background: rgba(255,255,255,0.02)">
                        <span style="font-weight:600;">${p.name}</span>
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <span class="score-badge">${p.score}</span>
                            <button onclick="award('${p.id}', 10)" class="btn btn-primary" style="padding: 4px 10px; font-size:0.7rem; background: #6366f1;">+10</button>
                        </div>
                    </li>
                `).join('');
        });

        socket.on('buzzReceived', (buzzers) => {
            const firstBuzzTime = buzzers[0].timestamp;

            buzzResults.innerHTML = buzzers.map((b, i) => {
                const posClass = (i === 0) ? 'pos-1' : (i === 1) ? 'pos-2' : (i === 2) ? 'pos-3' : 'pos-any';
                const timeDiff = i === 0 ? 'FASTEST' : `+${((b.timestamp - firstBuzzTime) / 1000).toFixed(3)}s`;

                return `
                <div class="position-card ${posClass}" style="margin-bottom: 0.75rem;">
                    <div class="rank-circle">#${i + 1}</div>
                    <div>
                        <div style="font-weight: 800; font-size: 1.4rem;">${b.name}</div>
                        <div class="time-gap">${timeDiff}</div>
                    </div>
                    <div style="margin-left: auto;">
                        <button onclick="award('${b.socketId}', 10)" class="btn" style="padding: 8px 16px; font-size: 0.8rem; background: #6366f1; color: white;">+10</button>
                    </div>
                </div>
                `;
            }).join('');
        });

        socket.on('historyUpdate', (history) => {
            historyLog.innerHTML = history.reverse().map(h => `
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05)">
                    [${h.timestamp}] Winners: ${h.winners.join(', ') || 'None'}
                </div>
            `).join('');
        });

        socket.on('lockStatus', (isLocked) => {
            startBtn.disabled = !isLocked;
            startBtn.style.opacity = isLocked ? '1' : '0.5';
            lockBtn.style.display = isLocked ? 'none' : 'block';
        });

        socket.on('roundStarted', () => {
            buzzResults.innerHTML = '<p style="text-align:center; color: #39FF14; font-weight: 800;">ROUND ACTIVE - WAITING...</p>';
        });

        socket.on('roundReset', () => {
            buzzResults.innerHTML = '';
        });

        function award(socketId, pts) {
            socket.emit('admin_awardPoints', { socketId, points: pts });
        }
    </script>
</body>

</html>